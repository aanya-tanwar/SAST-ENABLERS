name: SAST Pipeline - Filesystem

on:
  pull_request:
    branches:
      - '**'
    types: [opened, synchronize, reopened]

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --source=. --exit-code=1 --verbose --report-format=json --report-path=gitleaks-report.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for org repos
        continue-on-error: true  # Don't fail pipeline on secrets found

  trivy-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    needs: gitleaks-scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.51.1/trivy_0.51.1_Linux-64bit.tar.gz
          tar -zxvf trivy_0.51.1_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: Run Trivy Filesystem Scan
        run: |
          trivy fs . --format table --output trivy-report.txt || true
          # '|| true' ensures scan errors won't fail job

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

  sonarqube:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    needs: trivy-scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true  # Prevent pipeline failure on scan error

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 10
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true  # Don't fail pipeline if quality gate fails
