definitions:
  caches:
    sonar: ~/.sonar
    trivydb: /root/.cache/trivy

pipelines:
  pull-requests:
    "**":
      - step:
          name: Gitleaks Secret Scan
          image: docker:20.10.16
          services:
            - docker
          script:
            - echo "Running Gitleaks scan (non-blocking)"
            - docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest detect --source=/repo --exit-code=1 --verbose || true
            - echo "Gitleaks scan completed. Pipeline will not fail if secrets are found."

      - step:
          name: Trivy Filesystem Scan
          image: alpine:3.18
          caches:
            - trivydb
          script:
            - apk add --no-cache curl tar bash
            - |
              TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep tag_name | cut -d '"' -f 4)
              curl -L "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VERSION}/trivy_${TRIVY_VERSION#v}_Linux-64bit.tar.gz" -o trivy.tar.gz
              tar -zxvf trivy.tar.gz
              mv trivy /usr/local/bin/
              trivy version
            - echo "Running Trivy filesystem scan (non-blocking)..."
            - trivy fs . --format table --output trivy-report.txt || true
          artifacts:
            - trivy-report.txt

      - step:
          name: SonarQube Analysis
          caches:
            - sonar
          script:
            - echo "Running SonarQube scan (non-blocking)..."
            - pipe: sonarsource/sonarqube-scan:3.1.0
              variables:
                SONAR_HOST_URL: ${SONAR_HOST_URL}
                SONAR_TOKEN: ${SONAR_TOKEN}
            - echo "Checking SonarQube Quality Gate (non-blocking)..."
            - pipe: sonarsource/sonarqube-quality-gate:1.2.0
              variables:
                SONAR_HOST_URL: ${SONAR_HOST_URL}
                SONAR_TOKEN: ${SONAR_TOKEN}
            - echo "SonarQube scan and quality gate check completed. Pipeline continues regardless of result."
